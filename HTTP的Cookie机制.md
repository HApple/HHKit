### HTTP的Cookie机制

#### 什么是Cookie?

随着HTTP应用领域的不断扩大，对 “记忆能力”的需求也越来越强烈。比如网上论坛，电商购物，都需要“看客下单”，只有记住用户的身份才能执行发帖子、下订单等一系列会话事务。

HTTP的Cookie机制相当于服务器给每个客户端都贴上一张小纸条，上面写了一些只有服务器才能理解的数据，需要的时候客户端把这些信息发给服务器，服务器看到Cookie,就能够认出对方是谁了。

#### Cooike的工作过程

那么，Cookie这张小纸条是怎么传递的呢？

这要用到两个字段：响应头字段 **Set-Cookie** 和 请求头字段 **Cookie**.

当用户通过浏览器第一次访问服务器的时候，服务器肯定是不知道他的身份的。所以，就要创建一个独特的身份标识数据，格式是 **“key=value”**,然后放进 **Set-Cookie**字段里，随着响应报文一同发给浏览器。

浏览器收到响应报文，看到里面有 **Set-Cookie**,知道这是服务器给的身份标识，于是就保存起来，下次再请求的时候就自动把这个值放进**Cookie**字段里发给服务器。

因为第二次请求里面有了**Cookie**字段，服务器就知道这个用户不是新人，之前来过，就可以拿出**Cookie**里的值，识别出用户的身份，然后提供个性化的服务。

不过因为服务器的 “记忆能力”实在是太差，一张小纸条经常不够用。所以，服务器有时会在响应头里添加多个**Set-Cookie**,存储多个**"Key=value"**.但浏览器这边发送时不需要用多个**"Cookie"**字段，只要在一行里用**";"**隔开就行。

我画了一张图来描述这个过程，你看过就能理解了。

![未命名文件](https://tva1.sinaimg.cn/large/007S8ZIlgy1ggcqceo5ngj30pk08l3z2.jpg)

从这张图我们也能够看到， **Cookie** 是由浏览器负责存储的，而不是操作系统。所以，它是“浏览器绑定”的，只能在本浏览器内生效。

如果你换个浏览器或者换台电脑，新的浏览器里没有服务器对应的 **Cookie**,就好像是脱掉了贴着纸条的衣服，"健忘"的服务器就认不出来了，只能再走一遍 "Set-Cookie"流程。

#### Cookie的属性

说到这里，你应该知道，**Cookie**就是服务器委托浏览器在客户端里的一些数据，而这些数据通常都会记录用户的关键识别信息。所以，就需要在 **"key=value"**外再用一些手段来保护，防止外泄或窃取，这些手段就是**Cookie**的属性。

下面截图是实际案例的响应头，我来对着这个实际案例讲一下都有哪些常见的**Cookie**属性。

![image-20200702172303679](https://tva1.sinaimg.cn/large/007S8ZIlgy1ggcr4dqf0kj312q0e6ahy.jpg)

首先，我们应该**设置Cookie的生存周期**，也就是它的有效期，让它只能在一段时间内可用，就像是食品的“保鲜期”，一旦超过这个期限浏览器就认为是Cookie失效，在存储里删除，也不会发送给服务器。

**Cookie**的有效期可以使用**Expires**和**Max-Age**两个属性来设置。

**Expires**俗称“过期时间”，用的是绝对时间点，可以理解为“截止日期”(deadline)。“**Max-Age**”用的是相对时间，单位是秒，浏览器用收到报文的时间点再加上**Max-Age**,就可以得到失效的绝对时间。

**Expires**和**Max-Age**可以同时出现，两者的失效时间可以一致，也可以不一致，但浏览器会有限采用**Max-Age**计算失效期。

比如在这个例子里，**Expires**标记的过期时间是“GMT 2019年6月7号8点19分”，而**Max-Age**则只有10秒，如果现在是6月6号零点，那么**Cookie**的时间有效期就是“6月6号零点过10秒”。

其次，我们需要**设置Cookie的作用域**，**让浏览器仅发送给特定的服务器和URI**，避免被其他网站盗用。

作用域的设置比较简单，“**Domain**” 和 “**Path**” 指定了**Cookie**所属的域名和路径，浏览器在发送**Cookie**前会从**URI**中提取出**host**和**path**部分，对比**Cookie**的属性，如果不满足条件，就不会在请求头里发送**Cookie**。

使用这两个属性可以为不同的域名和路径分别设置各自的**Cookie**，比如“/19-1”用一个Cookie,“/19-2”再用另外一个Cookie，两者互不干扰。不过现实中为了省事，通常Path就用一个“/”或者直接省略，表示域名下的任意路劲都允许使用**Cookie**,让服务器自己去挑。

最后要考虑的就是**Cookie的安全性**了，尽量不要让服务器以外的人看到。

写过前端的同学一定知道，在JS脚本里可以用document.cookie来读写Cookie数据，这就带来了安全隐患，有可能会导致“跨站脚本”(XSS)攻击窃取数据。

属性 “**HTTPOnly**”会告诉浏览器，此Cookie只能通过浏览器HTTP协议传输，禁止其他方式访问，浏览器的JS引擎就会禁用document.cookie等一切相关的API，脚本攻击也就无从谈起了。



另一个属性 “**SameSite**”可以防范“跨站请求伪造”（XSRF）攻击，设置成“SameSite=Strict”可以严格限定Cookie不能随着跳转链接跨站发送，而“SameSite=Lax”则略宽松一点，允许GET/HEAD等安全方法，但禁止POST跨站发送。

还有一个属性叫“**Secure**”,表示这个**Cookie**仅能用HTTPS协议加密传输，明文的HTTP协议会禁止发送。但**Cookie**本身是不加密的，浏览器里还是以明文的形式存在。

Chrome开发者工具是查看Cookie的有力工具，在"Network-Cookies"里可以看到单个页面Cookie的各种属性，另一个“Application”面板里则能够方便地看到全站的所有Cookie.

![image-20200702180000786](https://tva1.sinaimg.cn/large/007S8ZIlgy1ggcs6t8msqj312q0a2die.jpg)

![image-20200702180024733](https://tva1.sinaimg.cn/large/007S8ZIlgy1ggcs791jjoj31320eyn9f.jpg)

**Cookie的应用**

现在回到我们最开始的话题，有了Cookie,服务器就有了“记忆能力”，能够保存“状态”，那么应该如何使用Cookie呢？

Cookie最基本的一个用途就是**身份识别**，保存用户的登录信息，实现会话事务。

比如，你用账号和密码登录某电商，登录成功后网站服务器就会发给浏览器一个Cookie，内容大概是“name=yourid”,这样就成功地把身份标签贴在了你身上。

之后你在网站里随便访问哪件商品的页面，浏览器都会自动把身份Cookie发给服务器，所以服务器总会知道你的身份，一方面免去了重复登录的麻烦，另一方面也能够自动记录你的浏览记录和购物下单（在后台数据库或者也用Cookie）,实现了“状态保持”。

Cookie的另一个常见用途是**广告跟踪**

你上网的时候肯定看过很多的广告图片，这些图片背后都是广告商网站（例如Google），它会“偷偷地”给你贴上Cookie小纸条，这样你上其他的网站，别的广告就能用Cookie读出你的身份，然后做行为分析，再推给你广告。

这种Cookie不是由访问的主站存储的，所以又叫“第三方Cookie”（third-party cookie）。如果广告商势力很大，广告到处都是，那么就比较“恐怖”了，无论你走到哪里它都会通过Cookie认出你来，实现广告“精准打击”。

为了防止滥用Cookie搜集用户隐私，互联网组织相继提出了DNT（Do Not Track）和 P3P（Platform for Privacy Preferences Project）,但实际作用不大。

#### 小结

今天我们学习了HTTP里的Cookie知识。虽然现在已经出现了Local Web Storage技术，能够比Cookie存储更多的数据，但Cookie仍然是最通用、兼容性最强的客户端数据存储手段。

简单小结一下今天的内容。

1.Cookie是服务器委托浏览器存储的一些数据，让服务器有了“记忆能力”；

2.响应报文使用Set-Cookie字段发送“Key=value”形式的Cookie的值；

3.请求报文里用Cookie字段发送多个Cookie值；

4.为了保护Cookie，还要给它设置有效期、作用域等属性，常用的有Max-Age,Expires,Domain,HttpOnly等；

5.Cookie最基本的用途是身份识别，实现由状态的会话事务。

还要提醒你一点，因为Cookie并不属于HTTP标准（RFC6265，而不是RFC2616/7230），所以语法上与其他字段不太一致，使用的分隔符是 ";",与Accept等字段的是","不同，小心不要弄错了。

Cookie现在基本上都是以数据库记录的形式存放的（通常使用的是Sqlite）。浏览器对Cookie的数量和大小也都有限制，不允许无限存储，一般总大小不能超过4K。

如果不指定 **Expires** 或 Max-Age 属性，那么Cookie仅在浏览器运行时有效，一旦浏览器关闭就会失效，这被称为会话Cookie（session cookie）或内存Cookie（in-memory cookie），在Chrome里过期时间会显示为“Session”或“N/A”.

Max-Age=0，就是立即过期，不允许缓存，只能在浏览器运行期间有效。



#### 应用

将sessionId存储在Cookie中

后台通过sessionId 获取到用户对应的隐私数据